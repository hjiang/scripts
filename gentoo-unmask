#!/bin/bash
# Script to unmask packages on Gentoo by adding them to package.accept_keywords

set -euo pipefail

# Check if package name is provided
if [ $# -eq 0 ]; then
    echo "Usage: $0 <package-name>" >&2
    echo "Example: $0 dev-util/asdf-vm" >&2
    exit 1
fi

PACKAGE="$1"

# Validate package format (should contain category/name)
if [[ ! "$PACKAGE" =~ ^[a-z0-9_-]+/[a-z0-9_+-]+$ ]]; then
    echo "Error: Package name should be in format 'category/package'" >&2
    echo "Example: dev-util/asdf-vm" >&2
    exit 1
fi

# Determine architecture and map to Gentoo keyword
ARCH=$(uname -m)
case "$ARCH" in
    x86_64)
        KEYWORD="~amd64"
        ;;
    aarch64)
        KEYWORD="~arm64"
        ;;
    armv7l)
        KEYWORD="~arm"
        ;;
    i686)
        KEYWORD="~x86"
        ;;
    ppc64)
        KEYWORD="~ppc64"
        ;;
    *)
        echo "Error: Unsupported architecture: $ARCH" >&2
        exit 1
        ;;
esac

# Extract package name (last part after /) for filename
PACKAGE_NAME="${PACKAGE##*/}"
KEYWORDS_DIR="/etc/portage/package.accept_keywords"
KEYWORDS_FILE="$KEYWORDS_DIR/$PACKAGE_NAME"

# Entry to add
ENTRY="$PACKAGE $KEYWORD"

# Check if entry already exists
if [ -f "$KEYWORDS_FILE" ] && grep -Fxq "$ENTRY" "$KEYWORDS_FILE" 2>/dev/null; then
    echo "Package already unmasked: $ENTRY"
    exit 0
fi

# Add entry to file
echo "Adding: $ENTRY"
echo "$ENTRY" | sudo tee -a "$KEYWORDS_FILE" > /dev/null
echo "Successfully unmasked $PACKAGE with keyword $KEYWORD"
echo "File: $KEYWORDS_FILE"
