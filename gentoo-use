#!/bin/bash
# Script to set USE flags for packages on Gentoo by managing package.use files

set -euo pipefail

# Check if package name and at least one USE flag is provided
if [ $# -lt 2 ]; then
    echo "Usage: $0 <package-name> <use-flag> [use-flag...]" >&2
    echo "Example: $0 dev-util/asdf-vm fish bash -perl" >&2
    echo "Note: Prefix flags with - to disable them" >&2
    exit 1
fi

PACKAGE="$1"
shift
USE_FLAGS=("$@")

# Validate package format (should contain category/name)
if [[ ! "$PACKAGE" =~ ^[a-z0-9_-]+/[a-z0-9_+-]+$ ]]; then
    echo "Error: Package name should be in format 'category/package'" >&2
    echo "Example: dev-util/asdf-vm" >&2
    exit 1
fi

# Validate USE flags format (alphanumeric, underscore, hyphen, plus; may start with -)
for flag in "${USE_FLAGS[@]}"; do
    if [[ ! "$flag" =~ ^-?[A-Za-z0-9_+-]+$ ]]; then
        echo "Error: Invalid USE flag format: $flag" >&2
        echo "USE flags should contain only letters, numbers, underscore, hyphen, and plus" >&2
        echo "Prefix with - to disable: -flag" >&2
        exit 1
    fi
done

# Extract package name (last part after /) for filename
PACKAGE_NAME="${PACKAGE##*/}"
USE_DIR="/etc/portage/package.use"
USE_FILE="$USE_DIR/$PACKAGE_NAME"

# Function to parse existing USE flags from file
parse_existing_flags() {
    local file="$1"
    local pkg="$2"

    if [ ! -f "$file" ]; then
        echo ""
        return
    fi

    # Find the line for this package and extract flags
    # Format: category/package flag1 flag2 -flag3
    local line
    line=$(grep -E "^${pkg}[[:space:]]" "$file" 2>/dev/null || true)

    if [ -n "$line" ]; then
        # Remove package name and extract flags
        echo "$line" | sed -E "s|^${pkg}[[:space:]]+||"
    else
        echo ""
    fi
}

# Function to merge USE flags intelligently
merge_flags() {
    local existing="$1"
    shift
    local new_flags=("$@")

    # Convert existing flags to array
    local -A flag_map
    if [ -n "$existing" ]; then
        for flag in $existing; do
            flag_map["$flag"]=1
        done
    fi

    # Process new flags
    for new_flag in "${new_flags[@]}"; do
        if [[ "$new_flag" =~ ^- ]]; then
            # Disabling flag: remove -flag prefix to get base name
            local base_flag="${new_flag#-}"
            # Remove enabled version if it exists, add disabled version
            unset "flag_map[$base_flag]"
            flag_map["$new_flag"]=1
        else
            # Enabling flag: remove disabled version if it exists, add enabled version
            unset "flag_map[-$new_flag]"
            flag_map["$new_flag"]=1
        fi
    done

    # Convert back to sorted array (disabled flags first, then enabled)
    local disabled_flags=()
    local enabled_flags=()

    for flag in "${!flag_map[@]}"; do
        if [[ "$flag" =~ ^- ]]; then
            disabled_flags+=("$flag")
        else
            enabled_flags+=("$flag")
        fi
    done

    # Sort each group
    IFS=$'\n' disabled_flags=($(sort <<<"${disabled_flags[*]}"))
    IFS=$'\n' enabled_flags=($(sort <<<"${enabled_flags[*]}"))
    unset IFS

    # Combine: enabled first, then disabled
    echo "${enabled_flags[@]}" "${disabled_flags[@]}"
}

# Parse existing flags
EXISTING_FLAGS=$(parse_existing_flags "$USE_FILE" "$PACKAGE")

# Merge flags
MERGED_FLAGS=$(merge_flags "$EXISTING_FLAGS" "${USE_FLAGS[@]}")

# Create the entry
ENTRY="$PACKAGE $MERGED_FLAGS"

# Check if entry is unchanged
if [ -f "$USE_FILE" ]; then
    EXISTING_ENTRY=$(grep -E "^${PACKAGE}[[:space:]]" "$USE_FILE" 2>/dev/null || true)
    if [ "$EXISTING_ENTRY" = "$ENTRY" ]; then
        echo "USE flags already set: $ENTRY"
        exit 0
    fi
fi

# Write the entry
echo "Setting USE flags: $ENTRY"

if [ -f "$USE_FILE" ] && grep -qE "^${PACKAGE}[[:space:]]" "$USE_FILE" 2>/dev/null; then
    # Update existing entry
    sudo sed -i "s|^${PACKAGE}[[:space:]].*|${ENTRY}|" "$USE_FILE"
    echo "Updated existing entry in: $USE_FILE"
else
    # Add new entry
    echo "$ENTRY" | sudo tee -a "$USE_FILE" > /dev/null
    echo "Added new entry to: $USE_FILE"
fi

echo "Successfully configured USE flags for $PACKAGE"
